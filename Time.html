<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Precision Time</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #1a1a1a;
        font-family: "Courier New", monospace;
        color: #0f0;
        overflow: hidden;
      }
      #zone-display {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #888;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      #clock {
        font-size: 8rem;
        text-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        font-variant-numeric: tabular-nums;
        cursor: default;
        line-height: 1;
      }
      #latency-display {
        margin-top: 15px;
        font-size: 1rem;
        color: #555;
        opacity: 0; /* Hidden until sync completes */
        transition: opacity 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div id="zone-display"></div>

    <div id="clock">00:00:00</div>

    <div id="latency-display">Syncing...</div>

    <script>
      // --- Configuration ---
      const USER_ZONE = Intl.DateTimeFormat().resolvedOptions().timeZone;

      const ZONE_EL = document.getElementById("zone-display");
      const CLOCK_EL = document.getElementById("clock");
      const LATENCY_EL = document.getElementById("latency-display");

      // Set Zone Immediately
      ZONE_EL.textContent = USER_ZONE;

      // Formatter
      const timeFormatter = new Intl.DateTimeFormat("en-GB", {
        timeZone: USER_ZONE,
        hour12: false,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });

      let timeSkew = 0;

      // --- Clock Loop ---
      function tick() {
        const now = new Date(Date.now() + timeSkew);
        CLOCK_EL.textContent = timeFormatter.format(now);

        // Update exactly at the next second boundary for smoothness
        const msUntilNextSecond = 1000 - now.getMilliseconds();
        setTimeout(tick, msUntilNextSecond);
      }
      tick();

      // --- Network Sync ---
      const endpoints = [
        {
          url: `https://timeapi.io/api/Time/current/zone?timeZone=${USER_ZONE}`,
          parse: (d) => new Date(d.dateTime),
        },
        {
          url: `https://worldtimeapi.org/api/timezone/${USER_ZONE}`,
          parse: (d) => new Date(d.datetime),
        },
        {
          url: `https://worldtimeapi.org/api/ip`,
          parse: (d) => new Date(d.datetime),
        },
        {
          url: "https://aisenseapi.com/services/v1/datetime",
          parse: (d) => new Date(d.datetime),
        },
      ];

      async function syncTime() {
        // Fetch function that returns latency and skew, or null on error
        const fetchOne = async (ep) => {
          try {
            const t0 = Date.now();
            const res = await fetch(ep.url, {
              mode: "cors",
              cache: "no-store", // <--- This disables the cache
            });
            if (!res.ok) throw new Error();
            const json = await res.json();
            const t1 = Date.now();

            const latency = (t1 - t0) / 2;
            const serverTime = ep.parse(json).getTime() + latency;
            const skew = serverTime - Date.now();

            return { latency, skew };
          } catch (e) {
            return null;
          }
        };

        // Run all requests in parallel
        const results = await Promise.all(endpoints.map(fetchOne));

        // Filter out errors and sort by lowest latency (fastest first)
        const valid = results
          .filter((r) => r !== null)
          .sort((a, b) => a.latency - b.latency);

        if (valid.length > 0) {
          const best = valid[0]; // The fastest response

          // Apply the skew from the fastest source
          timeSkew = best.skew;

          // Update UI
          LATENCY_EL.textContent = `LATENCY: ${Math.round(best.latency)}ms`;
          LATENCY_EL.style.opacity = 1;
        } else {
          // If all fail, hide the latency line or show error
          LATENCY_EL.style.opacity = 0;
        }
      }

      syncTime();
    </script>
  </body>
</html>
