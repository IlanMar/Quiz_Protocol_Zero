<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tel Aviv Clock - 3 Distinct Requests</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #1a1a1a;
        font-family: "Courier New", Courier, monospace;
        color: #0f0;
      }
      #clock {
        font-size: 6rem;
        text-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        margin-bottom: 20px;
      }
      #status {
        font-size: 1rem;
        color: #888;
        text-align: center;
      }
      .highlight {
        color: #fff;
        font-weight: bold;
      }
      ul {
        list-style: none;
        padding: 0;
        margin-top: 20px;
        font-size: 0.9rem;
      }
      li {
        margin-bottom: 5px;
        padding: 5px 10px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
      }
    </style>
  </head>
  <body>
    <div id="clock">00:00:00</div>
    <div id="status">Syncing 3 distinct sources...</div>
    <ul id="results"></ul>

    <script>
      const clockElement = document.getElementById("clock");
      const statusElement = document.getElementById("status");
      const resultsElement = document.getElementById("results");
      let currentTime = null;

      const proxy = "https://corsproxy.io/?";

      // Three distinct services with unique keys
      const services = [
        {
          name: "TimeAPI.io",
          url: "https://timeapi.io/api/Time/current/zone?timeZone=Asia/Jerusalem",
          parse: (json) => new Date(json.dateTime),
        },
        {
          name: "WorldTime-Primary",
          url: "https://worldtimeapi.org/api/timezone/Asia/Jerusalem?source=primary",
          parse: (json) => new Date(json.datetime),
        },
        {
          name: "WorldTime-Backup",
          url: "https://worldtimeapi.org/api/timezone/Asia/Jerusalem?source=backup",
          parse: (json) => new Date(json.datetime),
        },
      ];

      function logResult(serviceName, duration, success, timeStr = "") {
        const li = document.createElement("li");
        li.style.color = success ? "#0f0" : "#f66";
        li.innerHTML = `<strong>${serviceName}:</strong> ${success ? timeStr : "Failed"} <span style="color:#666">(${Math.round(duration)}ms)</span>`;
        resultsElement.appendChild(li);
      }

      const fetchTime = async (service) => {
        const start = performance.now();

        // Ensure every URL is globally unique to prevent browser deduping
        const uniqueUrl = `${service.url}&ts=${Date.now()}&rand=${Math.random()}`;

        // Proxy the WorldTimeAPI requests
        const finalUrl = service.name.includes("WorldTime")
          ? proxy + encodeURIComponent(uniqueUrl)
          : uniqueUrl;

        try {
          const response = await fetch(finalUrl, {
            cache: "no-store",
            mode: "cors",
          });

          const duration = performance.now() - start;
          if (!response.ok) throw new Error();

          const data = await response.json();
          const time = service.parse(data);

          const adjustedTime = new Date(time.getTime() + duration / 2);
          const timeStr = adjustedTime.toLocaleTimeString("en-GB", {
            timeZone: "Asia/Jerusalem",
            hour12: false,
          });

          logResult(service.name, duration, true, timeStr);
          return { adjustedTime, service, duration };
        } catch (err) {
          const duration = performance.now() - start;
          logResult(service.name, duration, false);
          throw err;
        }
      };

      async function init() {
        // Fire all 3 at once
        const promises = services.map((s) => fetchTime(s));

        try {
          // Promise.any grabs the first one that wins the race
          const fastest = await Promise.any(promises);
          currentTime = fastest.adjustedTime;
          statusElement.innerHTML = `Winner: <span class="highlight">${fastest.service.name}</span> (${Math.round(fastest.duration)}ms)`;

          updateDisplay();
          setInterval(tick, 1000);
        } catch (err) {
          statusElement.innerText = "All sources failed.";
        }
      }

      function tick() {
        if (currentTime) {
          currentTime.setSeconds(currentTime.getSeconds() + 1);
          updateDisplay();
        }
      }

      function updateDisplay() {
        if (currentTime) {
          clockElement.innerText = currentTime.toLocaleTimeString("en-GB", {
            timeZone: "Asia/Jerusalem",
            hour12: false,
          });
        }
      }

      init();
    </script>
  </body>
</html>
