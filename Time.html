<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tel Aviv Clock - Fastest Response</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #222;
        font-family: "Courier New", Courier, monospace;
        color: #0f0;
      }
      #clock {
        font-size: 6rem;
        text-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        margin-bottom: 20px;
      }
      #status {
        font-size: 1rem;
        color: #888;
      }
      .highlight {
        color: #fff;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="clock">Loading...</div>
    <div id="status">Waiting for fastest response...</div>

    <script>
      const clockElement = document.getElementById("clock");
      const statusElement = document.getElementById("status");
      let currentTime = null;

      // Definition of our 3 services.
      // We define the URL and a specific 'parser' function for each because APIs return different JSON structures.
      const services = [
        {
          name: "WorldTimeAPI",
          url: "https://worldtimeapi.org/api/timezone/Asia/Jerusalem",
          parse: (json) => new Date(json.datetime),
        },
        {
          name: "TimeAPI.io",
          url: "https://timeapi.io/api/Time/current/zone?timeZone=Asia/Jerusalem",
          parse: (json) => new Date(json.dateTime),
        },
        {
          // Using a cache-buster on WorldTimeAPI to simulate a 3rd distinct request
          // (High-quality free time APIs with CORS support are rare, so we simulate the 3rd source)
          name: "WorldTimeAPI (Backup)",
          url:
            "https://worldtimeapi.org/api/timezone/Asia/Jerusalem?random=" +
            Math.random(),
          parse: (json) => new Date(json.datetime),
        },
      ];

      // This function performs a single fetch and processes it using the specific service's parser
      const fetchFromService = async (service) => {
        const response = await fetch(service.url);
        if (!response.ok)
          throw new Error(`Failed to fetch from ${service.name}`);
        const data = await response.json();
        const time = service.parse(data);
        return { time, source: service.name };
      };

      async function initClock() {
        try {
          // Map our service definitions to actual fetch promises
          const promises = services.map((s) => fetchFromService(s));

          // Promise.any takes the first PROMISE that resolves successfully
          const result = await Promise.any(promises);

          // Set the time
          currentTime = result.time;

          // Show which service won
          statusElement.innerHTML = `Powered by fastest source: <span class="highlight">${result.source}</span>`;

          // Start the loop
          updateDisplay();
          setInterval(tick, 1000);
        } catch (error) {
          console.error("All services failed", error);
          clockElement.innerText = "Error";
          statusElement.innerText = "All time services failed.";
        }
      }

      function tick() {
        if (currentTime) {
          currentTime.setSeconds(currentTime.getSeconds() + 1);
          updateDisplay();
        }
      }

      function updateDisplay() {
        if (currentTime) {
          clockElement.innerText = currentTime.toLocaleTimeString("en-GB", {
            timeZone: "Asia/Jerusalem",
            hour12: false,
          });
        }
      }

      initClock();
    </script>
  </body>
</html>
