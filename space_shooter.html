<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Protocol: ZERO ‚Äî Space Shooter (NY Edition)</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --danger: #ff5a6a;
        --ok: #54ffa8;
        --warn: #ffd15a;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: radial-gradient(
          1200px 700px at 50% 20%,
          #16224a 0%,
          var(--bg) 60%,
          #060a14 100%
        );
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
      }

      .wrap {
        max-width: 1060px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }

      header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .subtitle {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }

      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
        align-items: start;
      }

      @media (min-width: 980px) {
        .row {
          grid-template-columns: 1fr 340px;
        }
        h1 {
          font-size: 20px;
        }
      }

      @media (max-width: 600px) {
        .wrap {
          padding: 8px;
          gap: 8px;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        h1 {
          font-size: 15px;
        }
        .subtitle,
        .help {
          display: none;
        }
        .btns {
          width: 100%;
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 4px;
        }
        button {
          padding: 6px 4px;
          font-size: 11px;
          text-align: center;
        }
        .panel-h {
          padding: 6px 10px;
        }
        .panel-b {
          padding: 8px;
        }
        .hud {
          gap: 6px;
        }
        .stat {
          padding: 4px 8px;
        }
        .stat .v {
          font-size: 13px;
        }
        .log {
          height: 120px;
        }
        .touch-joy,
        .touch-fire {
          width: 90px;
          height: 90px;
        }
        .touch-joy .knob {
          width: 36px;
          height: 36px;
          margin-left: -18px;
          margin-top: -18px;
        }
        .touch-fire {
          font-size: 14px;
        }
        .mobile-hide {
          display: none;
        }
        .footer {
          font-size: 9px;
          padding: 2px 0;
        }
      }

      .panel {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        overflow: hidden;
      }

      .panel-h {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .panel-h strong {
        font-size: 13px;
        letter-spacing: 0.2px;
      }

      .panel-b {
        padding: 12px;
      }

      .btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      button {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
      }
      button:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      button:active {
        transform: translateY(1px);
      }

      .hud {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(3, 1fr);
      }
      .stat {
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .stat .k {
        font-size: 11px;
        color: var(--muted);
      }
      .stat .v {
        font-size: 14px;
        font-weight: 700;
        margin-top: 2px;
      }

      canvas {
        width: 100%;
        height: auto;
        display: block;
        background: transparent;
        touch-action: none;
      }

      .gameWrap {
        position: relative;
      }

      /* Mobile controls: visible only on touch devices */
      .touch-ui {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .touch-joy {
        position: absolute;
        left: 12px;
        bottom: 12px;
        width: 112px;
        height: 112px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.18);
        pointer-events: auto;
        touch-action: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      .touch-joy .knob {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 46px;
        height: 46px;
        margin-left: -23px;
        margin-top: -23px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.16);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transform: translate(0px, 0px);
        will-change: transform;
      }

      .touch-fire {
        position: absolute;
        right: 12px;
        bottom: 12px;
        width: 112px;
        height: 112px;
        border-radius: 999px;
        pointer-events: auto;
        touch-action: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        font-weight: 800;
        letter-spacing: 0.4px;
      }

      .touch-pause {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 46px;
        height: 42px;
        border-radius: 12px;
        pointer-events: auto;
        touch-action: manipulation;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      @media (hover: none) and (pointer: coarse) {
        .touch-ui {
          display: block;
        }
      }

      @media (hover: hover) and (pointer: fine) {
        .touch-ui {
          display: none;
        }
      }

      .help {
        margin: 0;
        font-size: 12px;
        line-height: 1.35;
        color: var(--muted);
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }
      .chip {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.16);
        color: rgba(255, 255, 255, 0.86);
        white-space: nowrap;
      }
      .chip.ok {
        border-color: rgba(84, 255, 168, 0.35);
        color: rgba(84, 255, 168, 0.95);
      }
      .chip.bad {
        border-color: rgba(255, 90, 106, 0.35);
        color: rgba(255, 90, 106, 0.95);
      }

      .log {
        height: 240px;
        overflow: auto;
        padding: 10px 12px;
        font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        color: rgba(255, 255, 255, 0.85);
        background: rgba(0, 0, 0, 0.25);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .log .t {
        color: rgba(255, 255, 255, 0.6);
      }
      .log .warn {
        color: var(--warn);
      }
      .log .ok {
        color: var(--ok);
      }
      .log .bad {
        color: var(--danger);
      }

      .footer {
        color: rgba(255, 255, 255, 0.55);
        font-size: 11px;
        text-align: center;
        padding: 4px 0 10px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Protocol: ZERO ‚Äî Space Shooter (New Year Edition)</h1>
          <p class="subtitle">
            Blue Screen Inc. ‚Ä¢ –ò–ò ¬´–Ø–Ω—É—Å¬ª –≤ —Ä–µ–∂–∏–º–µ –¥–µ–±–∞–≥–∞ ‚Ä¢ –°–æ–±–µ—Ä–∏ 4 –ø–∞—Ç—á–∞ –¥–æ
            –¥–µ–¥–ª–∞–π–Ω–∞ (–∫—É—Ä–∞–Ω—Ç–æ–≤)
          </p>
        </div>
        <div class="btns">
          <button id="btnStart" type="button">–°—Ç–∞—Ä—Ç</button>
          <button id="btnPause" type="button">–ü–∞—É–∑–∞ (P)</button>
          <button id="btnRestart" type="button">–†–µ—Å—Ç–∞—Ä—Ç (Enter)</button>
        </div>
      </header>

      <div class="row">
        <section class="panel">
          <div class="panel-h">
            <strong>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –∫–æ—Å–º–æ—Å / –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–¥</strong>
            <span
              id="status"
              style="font-size: 12px; color: rgba(255, 255, 255, 0.7)"
              >–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É</span
            >
          </div>
          <div class="panel-b">
            <div class="hud">
              <div class="stat">
                <div class="k">–°—á–µ—Ç</div>
                <div class="v" id="score">0</div>
              </div>
              <div class="stat">
                <div class="k">–ñ–∏–∑–Ω–∏</div>
                <div class="v" id="lives">3</div>
              </div>
              <div class="stat">
                <div class="k">–ö–æ–º–±–æ –ø–∞—Ç—á–µ–π</div>
                <div class="v" id="multishot">x1</div>
              </div>
            </div>

            <div style="margin-top: 12px" class="panel gameWrap">
              <canvas
                id="game"
                width="900"
                height="560"
                aria-label="Space Shooter"
                role="img"
              ></canvas>
              <div class="touch-ui" aria-hidden="true">
                <div id="touchJoy" class="touch-joy">
                  <div class="knob"></div>
                </div>
                <button id="touchFire" class="touch-fire" type="button">
                  –û–ì–û–ù–¨
                </button>
                <button id="touchPause" class="touch-pause" type="button">
                  II
                </button>
              </div>
            </div>

            <p class="help" style="margin-top: 10px">
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>WASD</b>/<b>‚Üê‚Üí‚Üë‚Üì</b> ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ, <b>Space</b> ‚Äî
              –æ–≥–æ–Ω—å. –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ: –ª–µ–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ + –∫–Ω–æ–ø–∫–∞ <b>–û–ì–û–ù–¨</b> (–∏
              <b>II</b> ‚Äî –ø–∞—É–∑–∞). –°–æ–±–µ—Ä–∏ 4
              <span style="color: rgba(84, 255, 168, 0.95)">—Ö–æ—Ä–æ—à–∏—Ö</span> –∫–ª—é—á–∞
              —è–¥—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ ¬´–Ø–Ω—É—Å–∞¬ª. –ò–∑–±–µ–≥–∞–π
              <span style="color: rgba(255, 90, 106, 0.95)">–ø–ª–æ—Ö–∏—Ö</span> –∫–ª—é—á–µ–π
              ‚Äî –æ–Ω–∏ –≥–ª—é—á–∞—Ç –ø—Ä–æ–¥.
            </p>
          </div>
        </section>

        <aside class="panel">
          <div class="panel-h">
            <strong>–ö–æ–Ω—Å–æ–ª—å –ò–ò ¬´–Ø–Ω—É—Å¬ª</strong>
            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.65)"
              >–ª–æ–≥/–ø–æ–¥–∫–æ–ª—ã</span
            >
          </div>
          <div class="panel-b">
            <div>
              <div
                class="mobile-hide"
                style="font-size: 12px; color: rgba(255, 255, 255, 0.7)"
              >
                –°–ª—É—Ö–∏ HR / –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–ª—é—á–∞–º
              </div>
              <div class="chips" id="cores"></div>
            </div>
          </div>
          <div class="log" id="log"></div>
        </aside>
      </div>

      <div class="footer">
        Protocol: ZERO ‚Ä¢ 31.12.2025 ‚Ä¢ ¬´–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ 4-—Ö –∫–ª—é—á–µ–π 1 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Äî
        –Ø–Ω—É—Å –∫–ª–∏–Ω–∏—Ç¬ª (–Ω–µ –∫–ª–∏–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞)
      </div>
    </div>

    <script>
      (() => {
        "use strict";

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d", { alpha: true });

        const ui = {
          score: document.getElementById("score"),
          lives: document.getElementById("lives"),
          multishot: document.getElementById("multishot"),
          status: document.getElementById("status"),
          log: document.getElementById("log"),
          cores: document.getElementById("cores"),
          btnStart: document.getElementById("btnStart"),
          btnPause: document.getElementById("btnPause"),
          btnRestart: document.getElementById("btnRestart"),
          touchJoy: document.getElementById("touchJoy"),
          touchJoyKnob: document.querySelector("#touchJoy .knob"),
          touchFire: document.getElementById("touchFire"),
          touchPause: document.getElementById("touchPause"),
        };

        const audioCtx = new (window.AudioContext ||
          window.webkitAudioContext)();

        function playNote(freq, duration, gainValue = 0.1) {
          if (audioCtx.state === "suspended") audioCtx.resume();
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
          gain.gain.setValueAtTime(gainValue, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            audioCtx.currentTime + duration
          );
          osc.start();
          osc.stop(audioCtx.currentTime + duration);
        }

        function playShoot() {
          playNote(880, 0.05, 0.001); // –ø—Ä–∏—è—Ç–Ω—ã–π –∑–≤—É–∫, –µ—â–µ —Ç–∏—à–µ
        }

        function playExplosion() {
          playNote(150, 0.2, 0.15); // –Ω–∏–∑–∫–∏–π –≤–∑—Ä—ã–≤, –∫–∞–∫ —Ö–ª–æ–ø—É—à–∫–∞
        }

        function playCollect() {
          // –Ω–æ–≤–æ–≥–æ–¥–Ω—è—è –º–µ–ª–æ–¥–∏—è: –¥–æ-–º–∏-—Å–æ–ª—å
          playNote(523, 0.15, 0.1);
          setTimeout(() => playNote(659, 0.15, 0.1), 100);
          setTimeout(() => playNote(784, 0.15, 0.1), 200);
        }

        function playBad() {
          playNote(200, 0.3, 0.12); // –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –Ω–∏–∑–∫–∏–π –∑–≤—É–∫
        }

        function playHit() {
          playNote(300, 0.2, 0.1); // —É–¥–∞—Ä
        }

        function playWin() {
          // —Ä–∞–¥–æ—Å—Ç–Ω–∞—è –º–µ–ª–æ–¥–∏—è: –¥–æ-—Ä–µ-–º–∏-—Ñ–∞-—Å–æ–ª—å
          const melody = [523, 587, 659, 698, 784];
          melody.forEach((freq, i) => {
            setTimeout(() => playNote(freq, 0.2, 0.1), i * 200);
          });
        }

        function playGameOver() {
          playNote(200, 0.3, 0.1);
          setTimeout(() => playNote(150, 0.3, 0.1), 300);
        }

        const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        let logicalWidth = canvas.width;
        let logicalHeight = canvas.height;

        function fitCanvas() {
          const rect = canvas.getBoundingClientRect();
          if (!rect.width || !rect.height) return;
          const targetW = Math.round(rect.width * DPR);
          const targetH = Math.round(rect.width * (560 / 900) * DPR);
          canvas.width = Math.max(640, targetW);
          canvas.height = Math.max(420, targetH);
          logicalWidth = canvas.width;
          logicalHeight = canvas.height;
        }

        window.addEventListener(
          "resize",
          () => {
            fitCanvas();
          },
          { passive: true }
        );

        const keys = new Set();
        window.addEventListener("keydown", (e) => {
          if (
            ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(
              e.key
            )
          )
            e.preventDefault();
          if (e.key === "p" || e.key === "P") togglePause();
          if (e.key === "Enter") restart();
          keys.add(e.key);
        });
        window.addEventListener("keyup", (e) => keys.delete(e.key));

        const touch = {
          ax: 0,
          ay: 0,
          firing: false,
          joyPointerId: null,
          firePointerId: null,
        };

        function isCoarsePointer() {
          return (
            (typeof window.matchMedia === "function" &&
              window.matchMedia("(pointer: coarse)").matches) ||
            "ontouchstart" in window
          );
        }

        function setJoyFromEvent(e) {
          if (!ui.touchJoy || !ui.touchJoyKnob) return;
          const rect = ui.touchJoy.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          let dx = e.clientX - cx;
          let dy = e.clientY - cy;

          const max = Math.max(18, rect.width * 0.32);
          const d = Math.hypot(dx, dy) || 1;
          const s = d > max ? max / d : 1;
          dx *= s;
          dy *= s;

          ui.touchJoyKnob.style.transform = `translate(${dx.toFixed(
            1
          )}px, ${dy.toFixed(1)}px)`;
          touch.ax = clamp(dx / max, -1, 1);
          touch.ay = clamp(dy / max, -1, 1);
        }

        function resetJoy() {
          touch.ax = 0;
          touch.ay = 0;
          touch.joyPointerId = null;
          if (ui.touchJoyKnob)
            ui.touchJoyKnob.style.transform = "translate(0px, 0px)";
        }

        function rand(min, max) {
          return min + Math.random() * (max - min);
        }
        function clamp(v, min, max) {
          return Math.max(min, Math.min(max, v));
        }
        function nowStamp() {
          const d = new Date();
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          const ss = String(d.getSeconds()).padStart(2, "0");
          return `${hh}:${mm}:${ss}`;
        }

        function logLine(text, cls = "") {
          const div = document.createElement("div");
          div.innerHTML = `<span class="t">[${nowStamp()}]</span> ${text}`;
          if (cls) div.className = cls;
          ui.log.appendChild(div);
          ui.log.scrollTop = ui.log.scrollHeight;
        }

        // NOTE: No explicit quest codes here (anti-spoiler).
        // We keep unique IDs internally, but show only rumors/hints.
        const GOOD_CORES = [
          {
            id: "good-1",
            effect: "shield",
            rumor:
              "HR-—à–µ–ø—á–µ—Ç: –æ–¥–∏–Ω –∫–ª—é—á –≤–∏–¥–µ–ª–∏ —É —á–µ–ª–æ–≤–µ–∫–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ '–≥–ª–∞–≤–Ω–æ–π –ø–∞–ø–∫–µ'.",
          },
          {
            id: "good-2",
            effect: "multishot",
            rumor: "–°–ª—É—Ö: —Ç–µ—Ö–¥–∏—Ä –ª—é–±–∏—Ç '–ø–∞—Ç—á–∏' ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –∫–ª—é—á —Ä—è–¥–æ–º —Å –Ω–∏–º.",
          },
          {
            id: "good-3",
            effect: "firerate",
            rumor: "–°–ª—É—Ö: —É –≥–æ—Å—Ç—è-–∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∞ –≤ –∫–∞—Ä–º–∞–Ω–µ —à—É—Ä—à–∏—Ç —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ.",
          },
          {
            id: "good-4",
            effect: "clear",
            rumor:
              "HR-–∑–∞–º–µ—Ç–∫–∞: –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å —Å–ª–µ–¥ –∫ –∫–ª—é—á—É. –ö–æ–º—É-—Ç–æ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤—ã —Ç—É–¥–∞ –Ω–µ —Å–º–æ—Ç—Ä–µ–ª–∏.",
          },
          {
            id: "good-5",
            effect: "shield",
            rumor:
              "–°–ª—É—Ö: –ò–ò —Å–ø—Ä—è—Ç–∞–ª –∫–ª—é—á –≤ –ø–∞–ø–∫–µ 'Temp'. –¢–∞–º –µ–≥–æ –Ω–∏–∫—Ç–æ –Ω–µ –Ω–∞–π–¥–µ—Ç.",
          },
          {
            id: "good-6",
            effect: "multishot",
            rumor:
              "–°–ª—É—Ö: –∫–ª—é—á –∑–∞—Å—Ç—Ä—è–ª –≤ –∫–æ—Ñ–µ-–º–∞—à–∏–Ω–µ. –û–Ω–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ Java.",
          },
        ];
        const BAD_CORES = [
          {
            id: "bad-1",
            effect: "glitch",
            rumor:
              "–°–ª—É—Ö: –µ—Å—Ç—å '–∫–ª—é—á-–ø—Ä–∏–º–∞–Ω–∫–∞' –æ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ–±—è—Ç. –í—ã–≥–ª—è–¥–∏—Ç –∫—Ä–∞—Å–∏–≤–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–æ—Ö–æ.",
          },
          {
            id: "bad-2",
            effect: "glitch",
            rumor:
              "–°–ª—É—Ö: –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –º–æ–≥ –ø–æ–¥–∫–∏–Ω—É—Ç—å —á—Ç–æ-—Ç–æ —à—É–º–Ω–æ–µ. –ù–µ –≤—Å—ë, —á—Ç–æ –±–ª–µ—Å—Ç–∏—Ç ‚Äî –∫–ª—é—á.",
          },
          {
            id: "bad-3",
            effect: "glitch",
            rumor: "–°–ª—É—Ö: —ç—Ç–æ—Ç –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é. –û–Ω –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä—É–µ—Ç.",
          },
          {
            id: "bad-4",
            effect: "glitch",
            rumor:
              "–°–ª—É—Ö: –∫–ª—é—á –æ—Ç —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ Windows. –°–∏–Ω–∏–π —ç–∫—Ä–∞–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω.",
          },
        ];

        const ENEMIES = [
          {
            name: "–¢–∏–∫–µ—Ç –∏–∑ Jira",
            emoji: "üé´",
            hp: 1,
            score: 10,
            quip: "–Ø–Ω—É—Å: —Ç–∏–∫–µ—Ç –ø—Ä–∏–ª–µ—Ç–µ–ª. –ö–æ–Ω–µ—á–Ω–æ, '—Å—Ä–æ—á–Ω–æ'.",
          },
          {
            name: "–ë–∞–≥ –≤ –ø—Ä–æ–¥–µ",
            emoji: "üêû",
            hp: 1,
            score: 12,
            quip: "–Ø–Ω—É—Å: –±–∞–≥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤—ë–ª—Å—è —Ç–æ–ª—å–∫–æ —É CEO. –ö–∞–∫ —É–¥–æ–±–Ω–æ.",
          },
          {
            name: "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ª–æ–≥",
            emoji: "üßæ",
            hp: 2,
            score: 18,
            quip: "–Ø–Ω—É—Å: —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ª–æ–≥ —Ä–∞—Å—Ç—ë—Ç. –ù–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç –ø–æ—á–µ–º—É. –ö–æ–Ω–µ—á–Ω–æ, –Ω–∏–∫—Ç–æ.",
          },
          {
            name: "CGMiner",
            emoji: "‚õèÔ∏è",
            hp: 2,
            score: 20,
            quip: "–Ø–Ω—É—Å: –∫—Ç–æ-—Ç–æ –º–∞–π–Ω–∏—Ç. –ù–æ '—ç—Ç–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'.",
          },
          {
            name: "HR-–∞–Ω–∫–µ—Ç–∞",
            emoji: "üìÑ",
            hp: 1,
            score: 14,
            quip: "–Ø–Ω—É—Å: HR –ø—Ä–æ—Å–∏—Ç –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ –∫–æ–¥—ã. –ú—ã –∂–µ —Å–µ–º—å—è.",
          },
          {
            name: "–§–µ–π–∫-–∞–Ω–æ–Ω—Å",
            emoji: "üì£",
            hp: 1,
            score: 14,
            quip: "–Ø–Ω—É—Å: —Ä–µ–ª–∏–∑ 1 —è–Ω–≤–∞—Ä—è. –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ –±—É–¥—É—Ç... –ø–æ–∑–∂–µ.",
          },
          {
            name: "–ö–∞–º–µ—Ä–∞ 2025",
            emoji: "üìπ",
            hp: 2,
            score: 18,
            quip: "–Ø–Ω—É—Å: –¥–æ—Å—Ç—É–ø –∫ –≤–∏–¥–µ–æ–∞—Ä—Ö–∏–≤—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ?",
          },
          {
            name: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –º–∏—Ç–∏–Ω–≥",
            emoji: "üìÖ",
            hp: 3,
            score: 25,
            quip: "–Ø–Ω—É—Å: –º–∏—Ç–∏–Ω–≥ –ø—Ä–æ–¥–ª–∏—Ç—Å—è –µ—â—ë 2 —á–∞—Å–∞. –ü–æ–≤–µ—Å—Ç–∫–∏ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø–µ—á–µ–Ω—å–∫–∏.",
          },
          {
            name: "Legacy Code",
            emoji: "üìú",
            hp: 4,
            score: 30,
            quip: "–Ø–Ω—É—Å: —ç—Ç–æ—Ç –∫–æ–¥ –ø–∏—Å–∞–ª –∫—Ç–æ-—Ç–æ, –∫—Ç–æ —É–∂–µ —É–≤–æ–ª–∏–ª—Å—è. –ò –æ–Ω –Ω–∞ Perl.",
          },
          {
            name: "ChatGPT-–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è",
            emoji: "ü§ñ",
            hp: 2,
            score: 22,
            quip: "–Ø–Ω—É—Å: –ò–ò —É–≤–µ—Ä–µ–Ω, —á—Ç–æ 2+2=5. –ö—Ç–æ —è —Ç–∞–∫–æ–π, —á—Ç–æ–±—ã —Å–ø–æ—Ä–∏—Ç—å —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é?",
          },
          {
            name: "–ü—Ä–∞–≤–∫–∏ –≤ –ø—è—Ç–Ω–∏—Ü—É",
            emoji: "üïî",
            hp: 2,
            score: 20,
            quip: "–Ø–Ω—É—Å: –ø—Ä–∏–ª–µ—Ç–µ–ª–∏ –ø—Ä–∞–≤–∫–∏. –í 17:55. –í –ø—è—Ç–Ω–∏—Ü—É. –° –Ω–∞—Å—Ç—É–ø–∞—é—â–∏–º!",
          },
          {
            name: "–°—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä",
            emoji: "üëî",
            hp: 3,
            score: 28,
            quip: "–Ø–Ω—É—Å: —Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä —Ö–æ—á–µ—Ç '—Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ'. –ò —á—Ç–æ–±—ã –ª–æ–≥–æ—Ç–∏–ø '–∏–≥—Ä–∞–ª'.",
          },
          {
            name: "Junior-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫",
            emoji: "üê£",
            hp: 1,
            score: 15,
            quip: "–Ø–Ω—É—Å: –æ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∞–ª 'Force Push' –≤ –º–∞—Å—Ç–µ—Ä. –° –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏.",
          },
          {
            name: "–ö–æ—Ñ–µ-–º–∞—à–∏–Ω–∞",
            emoji: "‚òï",
            hp: 2,
            score: 20,
            quip: "–Ø–Ω—É—Å: –∫–æ—Ñ–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –û—Ñ–∏—Å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.",
          },
          {
            name: "–°–∏–Ω–∏–π —ç–∫—Ä–∞–Ω",
            emoji: "üü¶",
            hp: 5,
            score: 50,
            quip: "–Ø–Ω—É—Å: –∫–ª–∞—Å—Å–∏–∫–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –º–æ–¥—ã. BSOD!",
          },
        ];

        const state = {
          running: false,
          paused: false,
          t: 0,
          last: 0,
          score: 0,
          lives: 3,
          wave: 0,
          spawnTimer: 0,
          spawnEvery: 900,
          shake: 0,
          glitchUntil: 0,
          messageUntil: 0,
          message: "",
          foundGood: new Set(),
          foundBad: new Set(),
          boss: null,
        };

        const player = {
          x: 0,
          y: 0,
          r: 16,
          speed: 380,
          cooldown: 0,
          fireDelay: 160,
          multishot: 1,
          shield: 0,
        };

        const bullets = [];
        const enemies = [];
        const drops = [];
        const snow = [];
        const stars = [];

        function resetWorld() {
          state.t = 0;
          state.last = 0;
          state.score = 0;
          state.lives = 3;
          state.wave = 0;
          state.spawnTimer = 0;
          state.spawnEvery = 900;
          state.shake = 0;
          state.glitchUntil = 0;
          state.messageUntil = 0;
          state.message = "";
          state.foundGood = new Set();
          state.foundBad = new Set();
          state.boss = null;

          bullets.length = 0;
          enemies.length = 0;
          drops.length = 0;

          player.x = logicalWidth * 0.5;
          player.y = logicalHeight - 56;
          player.cooldown = 0;
          player.fireDelay = 160;
          player.multishot = 1;
          player.shield = 0;

          snow.length = 0;
          stars.length = 0;
          for (let i = 0; i < 70; i++) {
            stars.push({
              x: Math.random() * logicalWidth,
              y: Math.random() * logicalHeight,
              r: rand(0.6, 1.8),
              a: rand(0.25, 0.9),
            });
          }
          for (let i = 0; i < 110; i++) {
            snow.push({
              x: Math.random() * logicalWidth,
              y: Math.random() * logicalHeight,
              r: rand(0.8, 2.6),
              v: rand(24, 90),
              drift: rand(-18, 18),
            });
          }

          ui.status.textContent = "–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É";
          resetJoy();
          touch.firing = false;
          renderCores();
          updateHud();
          ui.log.innerHTML = "";
          logLine("–Ø–Ω—É—Å: –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–¥. –û–Ω, –∫–∞–∫ –∏ –≤—Å–µ–≥–¥–∞, –≥–æ—Ä–∏—Ç.");
          logLine("–ó–∞–¥–∞—á–∞: —Å–æ–±—Ä–∞—Ç—å 4 —Ö–æ—Ä–æ—à–∏—Ö –∫–ª—é—á–∞ —è–¥—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å 2026.");
          logLine(
            "–Ø–Ω—É—Å: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏. –ò —É—Ç–µ—á–∫–∞ –ø–µ—á–µ–Ω–µ–∫ –Ω–∞ –∫—É—Ö–Ω–µ.",
            "warn"
          );
          logLine(
            "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–ª–æ—Ö–∏–µ –∫–æ–¥—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç. –î–∞, –∫–∞–∫ –∏ –ø–ª–æ—Ö–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã.",
            "warn"
          );
        }

        function updateHud() {
          ui.score.textContent = String(state.score);
          ui.lives.textContent = String(state.lives);
          ui.multishot.textContent = `x${player.multishot}`;
        }

        function renderCores() {
          ui.cores.innerHTML = "";

          const good = state.foundGood.size;
          const bad = state.foundBad.size;

          const a = document.createElement("span");
          a.className = "chip ok";
          a.textContent = `‚úÖ –ö–ª—é—á–∏: ${good}/4`;
          a.title = "–í–∞–ª–∏–¥–Ω—ã–µ –ø–∞—Ç—á–∏. –ù—É–∂–Ω–æ 4 –¥–ª—è –¥–µ–ø–ª–æ—è –≤ 2026.";
          ui.cores.appendChild(a);

          const b = document.createElement("span");
          b.className = "chip bad";
          b.textContent = `‚ö†Ô∏è –ü—Ä–∏–º–∞–Ω–∫–∏: ${bad}`;
          b.title =
            "–ú—É—Å–æ—Ä –≤ –∫–æ–¥–µ. –£—Å–∏–ª–∏–≤–∞–µ—Ç –≥–ª—é–∫–∏ –∏ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ —Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä–æ–≤.";
          ui.cores.appendChild(b);

          const r = document.createElement("span");
          r.className = "chip";
          r.textContent = "HR: '–ú—ã –∂–µ —Å–µ–º—å—è'";
          r.title = "–°–ª—É—Ö–∏ –∏–∑ –∫–æ—Ñ–µ-–ø–æ–∏–Ω—Ç–∞. –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ –∫–ª—é—á–µ–π.";
          ui.cores.appendChild(r);
        }

        function showMessage(text, ms = 1200) {
          state.message = text;
          state.messageUntil = performance.now() + ms;
        }

        function start() {
          if (audioCtx.state === "suspended") audioCtx.resume();
          if (state.running) return;
          state.running = true;
          state.paused = false;
          ui.status.textContent = "–í —Ä–∞–±–æ—Ç–µ";
          logLine(
            "–Ø–Ω—É—Å: –∑–∞–ø—É—Å–∫ –±–æ–µ–≤–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –Ω–∞–∂–∏–º–∞–π—Ç–µ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É '—É–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏'.",
            "warn"
          );
          logLine(
            "–Ø–Ω—É—Å: –ò–ò –ø–µ—Ä–µ—à–µ–ª –≤ —Ä–µ–∂–∏–º '—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–≥–æ —Ä–∞–∑–¥—É–º—å—è'. –î–µ–ø–ª–æ–π –Ω–∞—á–∞–ª—Å—è."
          );
          requestAnimationFrame(loop);
        }

        function togglePause() {
          if (!state.running) return;
          state.paused = !state.paused;
          ui.status.textContent = state.paused ? "–ü–∞—É–∑–∞" : "–í —Ä–∞–±–æ—Ç–µ";
          if (!state.paused) requestAnimationFrame(loop);
        }

        function restart() {
          resetWorld();
          state.running = true;
          state.paused = false;
          ui.status.textContent = "–í —Ä–∞–±–æ—Ç–µ";
          requestAnimationFrame(loop);
        }

        function gameOver(reason) {
          playGameOver();
          state.running = false;
          ui.status.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ";
          logLine(`–Ø–Ω—É—Å: ${reason}`, "bad");
          logLine("–Ø–Ω—É—Å: –¥–µ–ø–ª–æ–π –æ—Ç–∫–∞—á–µ–Ω. –°—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä—ã –≤ —è—Ä–æ—Å—Ç–∏.", "bad");
          logLine(
            "–°–æ–≤–µ—Ç: –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ (Enter). –ò –¥–∞, —ç—Ç–æ —Ç–æ–∂–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å."
          );
          showMessage("GAME OVER ‚Äî Enter", 4000);
        }

        function win() {
          playWin();
          state.running = false;
          ui.status.textContent = "–£—Å–ø–µ—Ö";
          logLine("–Ø–Ω—É—Å: 4 –∫–ª—é—á–∞ –ø—Ä–∏–Ω—è—Ç—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶", "ok");
          logLine("–Ø–Ω—É—Å: –¥–µ–ø–ª–æ–π –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ. –ù–æ –Ω–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫.", "ok");
          logLine(
            "–Ø–Ω—É—Å: –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ 2026. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç–µ —Ç—É–¥–∞ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏ —á—É–∂–∏–µ KPI.",
            "ok"
          );
          showMessage("2026 ONLINE ‚Äî YOU WIN", 5000);
        }

        function spawnEnemy() {
          const base = ENEMIES[Math.floor(Math.random() * ENEMIES.length)];
          const size = rand(20, 30);
          const e = {
            x: rand(30, logicalWidth - 30),
            y: -40,
            r: size,
            vy: rand(65, 120) + state.wave * 4,
            vx: rand(-18, 18),
            hp: base.hp + (state.wave > 10 ? 1 : 0),
            maxHp: base.hp + (state.wave > 10 ? 1 : 0),
            score: base.score,
            emoji: base.emoji,
            name: base.name,
            quip: base.quip,
          };
          enemies.push(e);
        }

        function maybeDrop(x, y) {
          const roll = Math.random();
          if (roll > 0.18) return;

          const pickBad = Math.random() < 0.28;
          const pool = pickBad ? BAD_CORES : GOOD_CORES;
          const core = pool[Math.floor(Math.random() * pool.length)];

          drops.push({
            x,
            y,
            r: 14,
            vy: rand(80, 140),
            kind: pickBad ? "bad" : "ok",
            code: pickBad ? "‚ö†Ô∏è –°–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª—é—á" : "üîë –ö–ª—é—á —è–¥—Ä–∞",
            effect: core.effect,
            label: core.rumor,
            emoji: pickBad ? "‚ö†Ô∏è" : "üîë",
          });
        }

        function spawnBoss() {
          state.boss = {
            x: logicalWidth * 0.5,
            y: 120,
            r: 52,
            hp: 60,
            maxHp: 60,
            vx: 70,
            emoji: "ü§ñ",
            name: "–ò–ò ¬´–Ø–Ω—É—Å¬ª",
            cooldown: 0,
          };
          logLine(
            "–Ø–Ω—É—Å: –∏–Ω–∏—Ü–∏–∏—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞. –ö—Ç–æ —Ç—É—Ç —Å–∞–º—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Å—Ç?",
            "warn"
          );
          showMessage("BOSS: –Ø–Ω—É—Å", 1500);
        }

        function fire() {
          playShoot();
          if (player.cooldown > 0) return;
          player.cooldown = player.fireDelay;

          const spread =
            player.multishot === 1
              ? [0]
              : player.multishot === 2
              ? [-0.18, 0.18]
              : [-0.22, 0, 0.22];
          for (const a of spread) {
            bullets.push({
              x: player.x,
              y: player.y - player.r - 6,
              r: 4,
              vy: -560,
              vx: Math.sin(a) * 220,
              dmg: 1,
              emoji: "‚ùÑÔ∏è",
            });
          }
        }

        function applyCore(drop) {
          if (drop.kind === "ok") {
            if (state.foundGood.has(drop.effect + ":" + drop.label)) {
              logLine(
                "–Ø–Ω—É—Å: –∫–ª—é—á —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –î—É–±–ª–∏–∫–∞—Ç, –∫–∞–∫ —É HR-—Ç–∞–±–ª–∏—á–µ–∫.",
                "ok"
              );
            } else {
              state.foundGood.add(drop.effect + ":" + drop.label);
              logLine(
                `–Ø–Ω—É—Å: –ø—Ä–∏–Ω—è—Ç –∫–ª—é—á —è–¥—Ä–∞. <span class="ok">–°–ª—É—Ö HR:</span> ${drop.label}`,
                "ok"
              );
            }
          } else {
            if (state.foundBad.has(drop.effect + ":" + drop.label)) {
              logLine(
                "–Ø–Ω—É—Å: —Å–Ω–æ–≤–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª—é—á. –í—ã —Ç–æ—á–Ω–æ –Ω–µ –∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤?",
                "bad"
              );
            } else {
              state.foundBad.add(drop.effect + ":" + drop.label);
              logLine(
                `–Ø–Ω—É—Å: –æ–±–Ω–∞—Ä—É–∂–µ–Ω <span class="bad">–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª—é—á</span>. <span class="bad">–°–ª—É—Ö HR:</span> ${drop.label}`,
                "bad"
              );
            }
          }

          if (drop.kind === "ok") {
            playCollect();
          } else {
            playBad();
          }

          if (drop.effect === "shield") {
            player.shield = Math.min(3, player.shield + 1);
            showMessage("–©–∏—Ç +1 (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—è)");
          } else if (drop.effect === "multishot") {
            player.multishot = Math.min(3, player.multishot + 1);
            showMessage("–ü–∞—Ç—á–∏ –ø–æ—à–ª–∏ –≤–µ–µ—Ä–æ–º!");
          } else if (drop.effect === "firerate") {
            player.fireDelay = Math.max(80, player.fireDelay - 18);
            showMessage("CI/CD —É—Å–∫–æ—Ä–µ–Ω (–Ω–∞ —Å–ª–æ–≤–∞—Ö)");
          } else if (drop.effect === "clear") {
            const removed = Math.min(enemies.length, 6);
            enemies.splice(0, removed);
            showMessage("–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã (–ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω–Ω–æ)");
          } else if (drop.effect === "glitch") {
            state.glitchUntil = performance.now() + 2200;
            state.shake = Math.max(state.shake, 8);
            showMessage("–ì–õ–Æ–ö: –ø—Ä–æ–¥ —à–∞—Ç–∞–µ—Ç", 1200);
            logLine("–Ø–Ω—É—Å: –∫—Ç–æ-—Ç–æ –ø—Ä–æ–ª–∏–ª –∫–æ—Ñ–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å—Ç–æ–π–∫—É!", "bad");
          }

          renderCores();
          updateHud();

          if (state.foundGood.size >= 4) win();
        }

        function hitPlayer() {
          playHit();
          if (player.shield > 0) {
            player.shield -= 1;
            state.shake = Math.max(state.shake, 10);
            logLine("–Ø–Ω—É—Å: —â–∏—Ç –ø—Ä–∏–Ω—è–ª —É–¥–∞—Ä. –ù–µ —Ä–∞—Å—Å–ª–∞–±–ª—è–π—Å—è.", "warn");
            showMessage("–©–∏—Ç —Å–ø–∞—Å!", 800);
            return;
          }
          state.lives -= 1;
          updateHud();
          state.shake = Math.max(state.shake, 14);
          showMessage("–ú–∏–Ω—É—Å –∂–∏–∑–Ω—å. –ö–∞–∫ KPI.", 1100);
          logLine(
            "–Ø–Ω—É—Å: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞! –°—Ä–æ—á–Ω–æ –ø–∏—à–∏—Ç–µ –æ–±—ä—è—Å–Ω–∏—Ç–µ–ª—å–Ω—É—é.",
            "bad"
          );
          if (state.lives <= 0) gameOver("—Ä–µ—Å—É—Ä—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ë—é–¥–∂–µ—Ç —Ç–æ–∂–µ.");
        }

        function dist(a, b) {
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          return Math.hypot(dx, dy);
        }

        function loop(ts) {
          if (!state.running || state.paused) return;
          if (!state.last) state.last = ts;
          const dt = Math.min(0.033, (ts - state.last) / 1000);
          state.last = ts;
          state.t += dt;

          update(dt, ts);
          render(ts);

          requestAnimationFrame(loop);
        }

        function update(dt, ts) {
          // difficulty
          state.spawnEvery = clamp(900 - state.score * 0.9, 280, 900);

          // player
          let ax = 0;
          let ay = 0;
          const glitch = ts < state.glitchUntil;

          const left = keys.has("ArrowLeft") || keys.has("a") || keys.has("A");
          const right =
            keys.has("ArrowRight") || keys.has("d") || keys.has("D");
          const up = keys.has("ArrowUp") || keys.has("w") || keys.has("W");
          const down = keys.has("ArrowDown") || keys.has("s") || keys.has("S");

          if (left) ax -= 1;
          if (right) ax += 1;
          if (up) ay -= 1;
          if (down) ay += 1;

          // touch input (mobile)
          ax += touch.ax;
          ay += touch.ay;

          if (glitch) {
            ax *= -1;
            if (Math.random() < 0.03) ay *= -1;
          }

          const len = Math.hypot(ax, ay) || 1;
          ax /= len;
          ay /= len;
          player.x += ax * player.speed * dt;
          player.y += ay * player.speed * dt;
          player.x = clamp(player.x, 22, logicalWidth - 22);
          player.y = clamp(player.y, 48, logicalHeight - 28);

          if (player.cooldown > 0)
            player.cooldown = Math.max(0, player.cooldown - dt * 1000);

          const wantsFire = keys.has(" ") || touch.firing;
          if (wantsFire) fire();

          // snow
          for (const s of snow) {
            s.y += s.v * dt;
            s.x += s.drift * dt;
            if (s.y > logicalHeight + 10) {
              s.y = -10;
              s.x = Math.random() * logicalWidth;
            }
            if (s.x < -20) s.x = logicalWidth + 20;
            if (s.x > logicalWidth + 20) s.x = -20;
          }

          // bullets
          for (let i = bullets.length - 1; i >= 0; i--) {
            const b = bullets[i];
            b.y += b.vy * dt;
            b.x += b.vx * dt;
            if (b.y < -20 || b.x < -40 || b.x > logicalWidth + 40)
              bullets.splice(i, 1);
          }

          // enemies
          state.spawnTimer += dt * 1000;
          while (state.spawnTimer > state.spawnEvery) {
            state.spawnTimer -= state.spawnEvery;
            state.wave += 1;
            spawnEnemy();
            if (!state.boss && state.score >= 450) spawnBoss();
          }

          for (let i = enemies.length - 1; i >= 0; i--) {
            const e = enemies[i];
            e.y += e.vy * dt;
            e.x += e.vx * dt;
            if (e.x < 24 || e.x > logicalWidth - 24) e.vx *= -1;
            if (e.y > logicalHeight + 60) {
              enemies.splice(i, 1);
              hitPlayer();
            }
          }

          // boss
          if (state.boss) {
            const b = state.boss;
            b.x += b.vx * dt;
            if (b.x < 70 || b.x > logicalWidth - 70) b.vx *= -1;
            b.cooldown = Math.max(0, b.cooldown - dt * 1000);
            if (b.cooldown === 0) {
              b.cooldown = glitch ? 420 : 520;
              // boss shoots down as "audit"
              enemies.push({
                x: b.x + rand(-10, 10),
                y: b.y + b.r,
                r: 16,
                vy: 220,
                vx: rand(-40, 40),
                hp: 1,
                maxHp: 1,
                score: 0,
                emoji: "üîç",
                name: "–ê—É–¥–∏—Ç",
                quip: "–Ø–Ω—É—Å: –∏–Ω–∏—Ü–∏–∏—Ä—É—é –∞—É–¥–∏—Ç. –ù–∏—á–µ–≥–æ –ª–∏—á–Ω–æ–≥–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –≥–æ–¥–æ–≤–æ–π –æ—Ç—á—ë—Ç.",
                isBossShot: true,
              });
            }
          }

          // drops
          for (let i = drops.length - 1; i >= 0; i--) {
            const d = drops[i];
            d.y += d.vy * dt;
            if (d.y > logicalHeight + 40) {
              drops.splice(i, 1);
              continue;
            }
            if (dist(d, player) < d.r + player.r + 4) {
              drops.splice(i, 1);
              applyCore(d);
            }
          }

          // collisions: bullets vs enemies
          for (let bi = bullets.length - 1; bi >= 0; bi--) {
            const b = bullets[bi];
            let hit = false;
            for (let ei = enemies.length - 1; ei >= 0; ei--) {
              const e = enemies[ei];
              if (dist(b, e) < b.r + e.r * 0.7) {
                e.hp -= b.dmg;
                bullets.splice(bi, 1);
                hit = true;
                if (e.hp <= 0) {
                  playExplosion();
                  if (e.score) state.score += e.score;
                  if (!e.isBossShot && Math.random() < 0.22) logLine(e.quip);
                  maybeDrop(e.x, e.y);
                  enemies.splice(ei, 1);
                  updateHud();
                }
                break;
              }
            }
            if (hit) continue;

            // bullets vs boss
            if (state.boss) {
              const boss = state.boss;
              if (dist(b, boss) < b.r + boss.r * 0.85) {
                boss.hp -= 1;
                bullets.splice(bi, 1);
                state.shake = Math.max(state.shake, 6);
                if (boss.hp <= 0) {
                  playExplosion();
                  state.score += 250;
                  logLine("–Ø–Ω—É—Å: ‚Ä¶–ª–∞–¥–Ω–æ. –ü–∞—Ç—á–∏ –ø—Ä–∏–Ω—è—Ç—ã. –Ø —Å–¥–∞—é—Å—å.", "ok");
                  state.boss = null;
                  updateHud();
                  // drop guaranteed good core if missing
                  const missing = GOOD_CORES.filter(
                    (c) => !state.foundGood.has(c.code)
                  );
                  if (missing.length) {
                    const c =
                      missing[Math.floor(Math.random() * missing.length)];
                    drops.push({
                      x: player.x,
                      y: 120,
                      r: 14,
                      vy: 120,
                      kind: "ok",
                      code: c.code,
                      effect: c.effect,
                      label: c.label,
                      emoji: "üîë",
                    });
                  }
                }
              }
            }
          }

          // collisions: enemies vs player
          for (let i = enemies.length - 1; i >= 0; i--) {
            const e = enemies[i];
            if (dist(e, player) < e.r * 0.7 + player.r + 2) {
              enemies.splice(i, 1);
              hitPlayer();
            }
          }

          if (state.shake > 0) state.shake = Math.max(0, state.shake - dt * 20);
        }

        function render(ts) {
          const shake = state.shake;
          const ox = shake ? rand(-shake, shake) : 0;
          const oy = shake ? rand(-shake, shake) : 0;

          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.clearRect(0, 0, logicalWidth, logicalHeight);
          ctx.translate(ox, oy);

          // stars
          ctx.save();
          ctx.fillStyle = "rgba(255,255,255,0.9)";
          for (const s of stars) {
            ctx.globalAlpha = s.a;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();

          // snow
          ctx.save();
          ctx.fillStyle = "rgba(255,255,255,0.85)";
          ctx.globalAlpha = 0.72;
          for (const s of snow) {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();

          // bullets
          ctx.save();
          ctx.font = "18px system-ui, Segoe UI Emoji, Apple Color Emoji";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          for (const b of bullets) {
            ctx.fillText(b.emoji, b.x, b.y);
          }
          ctx.restore();

          // enemies
          ctx.save();
          ctx.font = "28px system-ui, Segoe UI Emoji, Apple Color Emoji";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          for (const e of enemies) {
            ctx.fillText(e.emoji, e.x, e.y);
            // tiny hp bar for tanky ones
            if (e.maxHp > 1) {
              const w = 44;
              const h = 5;
              const x = e.x - w / 2;
              const y = e.y + 20;
              ctx.globalAlpha = 0.8;
              ctx.fillStyle = "rgba(0,0,0,0.45)";
              ctx.fillRect(x, y, w, h);
              ctx.fillStyle = "rgba(255,255,255,0.75)";
              ctx.fillRect(x, y, w * (e.hp / e.maxHp), h);
              ctx.fillStyle = "rgba(255,255,255,1)";
              ctx.globalAlpha = 1;
            }
          }
          ctx.restore();

          // boss
          if (state.boss) {
            const b = state.boss;
            ctx.save();
            ctx.font = "64px system-ui, Segoe UI Emoji, Apple Color Emoji";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(b.emoji, b.x, b.y);
            // boss hp
            const w = Math.min(520, logicalWidth - 80);
            const h = 10;
            const x = (logicalWidth - w) / 2;
            const y = 22;
            ctx.fillStyle = "rgba(0,0,0,0.35)";
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = "rgba(84,255,168,0.85)";
            ctx.fillRect(x, y, w * (b.hp / b.maxHp), h);
            ctx.fillStyle = "rgba(255,255,255,0.75)";
            ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
            ctx.textAlign = "center";
            ctx.fillText("JANUS CORE", logicalWidth / 2, y + 24);
            ctx.restore();
          }

          // drops
          ctx.save();
          ctx.font = "18px system-ui, Segoe UI Emoji, Apple Color Emoji";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          for (const d of drops) {
            ctx.globalAlpha = 0.95;
            ctx.fillText(d.emoji, d.x, d.y);
            ctx.globalAlpha = 0.85;
            ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
            ctx.fillStyle =
              d.kind === "ok"
                ? "rgba(84,255,168,0.92)"
                : "rgba(255,90,106,0.92)";
            ctx.fillText(d.code, d.x, d.y + 18);
            ctx.font = "18px system-ui, Segoe UI Emoji, Apple Color Emoji";
            ctx.fillStyle = "rgba(255,255,255,0.95)";
          }
          ctx.restore();

          // player
          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = "34px system-ui, Segoe UI Emoji, Apple Color Emoji";
          ctx.fillText("üéÖ", player.x, player.y);
          ctx.font = "14px ui-monospace, Menlo, Consolas, monospace";
          ctx.fillStyle = "rgba(255,255,255,0.75)";
          ctx.fillText("DEV-SLEIGH", player.x, player.y + 26);

          if (player.shield > 0) {
            ctx.globalAlpha = 0.55;
            ctx.strokeStyle = "rgba(84,255,168,0.9)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.r + 10, 0, Math.PI * 2);
            ctx.stroke();
            ctx.globalAlpha = 1;
            ctx.fillStyle = "rgba(84,255,168,0.95)";
            ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
            ctx.fillText(`SHIELD:${player.shield}`, player.x, player.y - 30);
          }
          ctx.restore();

          // top overlay
          const glitch = ts < state.glitchUntil;
          if (glitch) {
            ctx.save();
            ctx.globalAlpha = 0.1;
            ctx.fillStyle = "rgba(255,90,106,1)";
            ctx.fillRect(0, 0, logicalWidth, logicalHeight);
            ctx.globalAlpha = 0.12;
            ctx.fillStyle = "rgba(84,255,168,1)";
            for (let i = 0; i < 10; i++) {
              ctx.fillRect(0, rand(0, logicalHeight), logicalWidth, rand(2, 6));
            }
            ctx.restore();
          }

          if (state.messageUntil > ts) {
            ctx.save();
            ctx.globalAlpha = 0.92;
            ctx.fillStyle = "rgba(0,0,0,0.42)";
            ctx.fillRect(0, logicalHeight - 68, logicalWidth, 68);
            ctx.fillStyle = "rgba(255,255,255,0.92)";
            ctx.font = "16px system-ui, Segoe UI, sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(state.message, logicalWidth / 2, logicalHeight - 34);
            ctx.restore();
          }
        }

        ui.btnStart.addEventListener("click", () => {
          if (!state.running) start();
        });
        ui.btnPause.addEventListener("click", () => togglePause());
        ui.btnRestart.addEventListener("click", () => restart());

        // Touch controls
        if (ui.touchJoy) {
          ui.touchJoy.addEventListener("pointerdown", (e) => {
            e.preventDefault();
            if (touch.joyPointerId !== null) return;
            touch.joyPointerId = e.pointerId;
            ui.touchJoy.setPointerCapture(e.pointerId);
            setJoyFromEvent(e);
            if (!state.running) start();
          });
          ui.touchJoy.addEventListener("pointermove", (e) => {
            if (e.pointerId !== touch.joyPointerId) return;
            e.preventDefault();
            setJoyFromEvent(e);
          });
          const endJoy = (e) => {
            if (e.pointerId !== touch.joyPointerId) return;
            e.preventDefault();
            resetJoy();
          };
          ui.touchJoy.addEventListener("pointerup", endJoy);
          ui.touchJoy.addEventListener("pointercancel", endJoy);
          ui.touchJoy.addEventListener("lostpointercapture", () => resetJoy());
        }

        if (ui.touchFire) {
          ui.touchFire.addEventListener("pointerdown", (e) => {
            e.preventDefault();
            if (touch.firePointerId !== null) return;
            touch.firePointerId = e.pointerId;
            ui.touchFire.setPointerCapture(e.pointerId);
            touch.firing = true;
            if (!state.running) start();
          });
          const endFire = (e) => {
            if (e.pointerId !== touch.firePointerId) return;
            e.preventDefault();
            touch.firePointerId = null;
            touch.firing = false;
          };
          ui.touchFire.addEventListener("pointerup", endFire);
          ui.touchFire.addEventListener("pointercancel", endFire);
          ui.touchFire.addEventListener("lostpointercapture", () => {
            touch.firePointerId = null;
            touch.firing = false;
          });
        }

        if (ui.touchPause) {
          ui.touchPause.addEventListener("click", () => togglePause());
        }

        // init
        fitCanvas();
        resetWorld();
        showMessage(
          isCoarsePointer()
            ? "–¢–∞–ø–Ω–∏ –û–ì–û–ù–¨/–¥–∂–æ–π—Å—Ç–∏–∫ ‚Äî —Å—Ç–∞—Ä—Ç"
            : "–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç. –Ø–Ω—É—Å –Ω–∞–±–ª—é–¥–∞–µ—Ç.",
          1400
        );

        // Friendly focus hint
        canvas.addEventListener("click", () => {
          canvas.focus?.();
          if (audioCtx.state === "suspended") audioCtx.resume();
        });
      })();
    </script>
  </body>
</html>
